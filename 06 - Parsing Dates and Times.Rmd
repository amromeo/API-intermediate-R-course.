---
title: "06 - Parsing Dates and Times"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Dealing with Dates and Times

Lubridate package summary

Reference : https://r4ds.had.co.nz/dates-and-times.html


```{r, message=FALSE}
all_batches <- dir_ls(here("data"), glob = "*_b.csv") %>%
  map_dfr(read_csv) %>%
  clean_names()
```

## Build Datetime Objects

today and now
ymd_hms and related functions
make_datetime
as_datetime

## Extract Datetime Components

Represent as date instead of datetime
Extract year, month, day, wee, day of week
Summarize/visualize by week, day of week
Rounding (floor_date)

Convert datetime to date data type

```{r}
batches_ts <- all_batches %>%
  mutate(review_complete_date = as_date(review_complete_timestamp))
ggplot(batches_ts, aes(x = review_complete_date)) +
  geom_histogram(bins = 12)
```

Extract month from datetime field

```{r}
batches_monthly <- all_batches %>%
  mutate(review_complete_month = month(review_complete_timestamp))
ggplot(batches_monthly, aes(x = review_complete_month)) +
  geom_histogram()
```

Exercise

What hours do the analytical team work? What days of the week is the lab open?

```{r}
batches_hourly <- all_batches %>%
  mutate(review_complete_hour = hour(review_complete_timestamp))
ggplot(batches_hourly, aes(x = review_complete_hour)) +
  geom_histogram()
```

```{r}
batches_daily <- all_batches %>%
  mutate(review_complete_daily = wday(review_complete_timestamp, label = TRUE))
ggplot(batches_daily, aes(x = review_complete_daily)) +
  geom_histogram(stat = "count")
```

Capture weekly data but keep datetime format

```{r}
batches_weekly <- all_batches %>%
  mutate(review_complete_weekly = floor_date(review_complete_timestamp, unit = "week"))
batches_weekly %>% count(review_complete_weekly) %>% View()
ggplot(batches_weekly, aes(x = review_complete_weekly)) +
  geom_bar()
```


## Calculate Time Spans

Difftime object
Represent as different human readable units

Subtraction of datetimes gives difftime object by default

```{r}
batches_tat <- all_batches %>%
  mutate(review_duration = review_complete_timestamp - review_start_timestamp)
ggplot(batches_tat, aes(x = review_duration)) +
  geom_histogram(binwidth = 1)
```

Output may change depending on magnitude of time difference

```{r}
mean(batches_tat$review_duration)
```

Duration data type provides unambiguous output

```{r}
batches_tat <- all_batches %>%
  mutate(review_duration = as.duration(review_complete_timestamp - review_start_timestamp))

```

Convert interval into numeric output by dividing by d... functions

```{r}
batches_tat <- all_batches %>%
  mutate(review_duration_min = (review_start_timestamp %--% review_complete_timestamp)/dminutes(1))
mean(batches_tat$review_duration)
```

Can use period functions like minutes() or hours() as intuitive way to generate time periods R can parse

floor and ceiling functions support rounding datetimes but keeping datetime format

```{r}
batches_tat_flag <- all_batches %>%
  mutate(meets_tat = if_else(review_complete_timestamp > review_start_timestamp + minutes(40), FALSE, TRUE),
         review_complete_weekly = floor_date(review_complete_timestamp, unit = "week"))
summary(batches_tat_flag)
ggplot(batches_tat_flag, aes(x = review_complete_weekly, fill = meets_tat)) +
  geom_bar()
```

